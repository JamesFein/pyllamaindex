<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIèŠå¤©åŠ©æ‰‹</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .chat-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .chat-header {
        background: #007bff;
        color: white;
        padding: 20px;
        text-align: center;
      }
      .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
      }
      .message {
        margin-bottom: 15px;
      }
      .user-message {
        text-align: right;
      }
      .bot-message {
        text-align: left;
      }
      .message-content {
        display: inline-block;
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
      }
      .user-message .message-content {
        background: #007bff;
        color: white;
      }
      .bot-message .message-content {
        background: #e9ecef;
        color: #333;
      }
      .chat-input {
        padding: 20px;
        border-top: 1px solid #ddd;
      }
      .input-group {
        display: flex;
        gap: 10px;
      }
      #messageInput {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: none;
      }
      #sendBtn {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      #sendBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .file-section {
        margin-bottom: 10px;
      }
      #uploadBtn {
        padding: 5px 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-right: 10px;
      }
      .uploaded-files {
        display: inline-block;
      }
      .file-tag {
        display: inline-block;
        background: #17a2b8;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        margin-right: 5px;
        font-size: 12px;
      }
      .remove-file {
        cursor: pointer;
        margin-left: 5px;
        font-weight: bold;
      }
      .loading {
        text-align: center;
        color: #666;
        font-style: italic;
      }
      .char-count {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 5px;
      }

      /* å¼•ç”¨æ ·å¼ */
      .citation {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        margin: 0 2px;
        cursor: pointer;
        border: 1px solid #bbdefb;
        position: relative;
      }
      .citation:hover {
        background: #bbdefb;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* å¼•ç”¨æ‚¬æµ®æç¤º */
      .citation-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        max-width: 300px;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        margin-bottom: 5px;
      }
      .citation-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: #333;
      }
      .citation:hover .citation-tooltip {
        opacity: 1;
      }

      /* å¼•ç”¨å†…å®¹æ‚¬æµ®æ¡† */
      .citation-content {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        font-size: 13px;
        max-width: 400px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1001;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        white-space: normal;
        line-height: 1.4;
      }
      .citation-content::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 8px solid transparent;
        border-top-color: white;
      }
      .citation:hover .citation-content {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h1>AIèŠå¤©åŠ©æ‰‹</h1>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
          <div class="message-content">
            ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
          </div>
        </div>
      </div>

      <div class="chat-input">
        <div class="file-section">
          <input
            type="file"
            id="fileInput"
            accept=".pdf,.txt,.doc,.docx"
            style="display: none"
          />
          <button id="uploadBtn">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
          <div id="uploadedFiles" class="uploaded-files"></div>
        </div>

        <div class="input-group">
          <textarea
            id="messageInput"
            placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..."
            rows="2"
            maxlength="2000"
          ></textarea>
          <button id="sendBtn">å‘é€</button>
        </div>

        <div class="char-count">0/2000</div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let chatId =
        "chat_" +
        Date.now() +
        "_" +
        Math.random().toString(36).substring(2, 11);
      let uploadedFiles = [];

      // DOMå…ƒç´ 
      let chatMessages,
        messageInput,
        sendBtn,
        fileInput,
        uploadBtn,
        uploadedFilesDiv,
        charCount;

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        chatMessages = document.getElementById("chatMessages");
        messageInput = document.getElementById("messageInput");
        sendBtn = document.getElementById("sendBtn");
        fileInput = document.getElementById("fileInput");
        uploadBtn = document.getElementById("uploadBtn");
        uploadedFilesDiv = document.getElementById("uploadedFiles");
        charCount = document.querySelector(".char-count");

        // ç»‘å®šäº‹ä»¶
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        messageInput.addEventListener("input", updateCharCount);
        uploadBtn.addEventListener("click", function () {
          fileInput.click();
        });
        fileInput.addEventListener("change", handleFileUpload);

        updateCharCount();
      });

      function updateCharCount() {
        const count = messageInput.value.length;
        charCount.textContent = count + "/2000";
        charCount.style.color = count > 1800 ? "#ff4757" : "#666";
      }

      // å‘é€æ¶ˆæ¯
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addMessage(message, "user");
        messageInput.value = "";
        updateCharCount();

        try {
          showLoading();
          const response = await callChatAPI(message);
          addMessage(response, "bot");
        } catch (error) {
          console.error("å‘é€æ¶ˆæ¯å¤±è´¥:", error);
          addMessage(
            "æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯ä¿¡æ¯: " + error.message,
            "bot"
          );
        } finally {
          hideLoading();
        }
      }

      async function callChatAPI(message) {
        const annotations = [];
        if (uploadedFiles.length > 0) {
          annotations.push({
            type: "document_file",
            data: {
              files: uploadedFiles,
            },
          });
        }

        const requestBody = {
          id: chatId,
          messages: [
            {
              role: "user",
              content: message,
              annotations: annotations,
            },
          ],
          data: {},
        };

        console.log("å‘é€è¯·æ±‚:", JSON.stringify(requestBody, null, 2));

        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(
            "APIè°ƒç”¨å¤±è´¥: " + response.status + " - " + errorText
          );
        }

        // å¤„ç†æµå¼å“åº”
        const responseText = await response.text();
        console.log("åŸå§‹å“åº”:", responseText);

        // è§£ææµå¼æ•°æ®
        return parseStreamResponse(responseText);
      }

      function parseStreamResponse(responseText) {
        try {
          console.log("åŸå§‹å“åº”:", responseText);

          // åˆ†å‰²æ¯ä¸€è¡Œæ•°æ®
          const lines = responseText.split("\n").filter((line) => line.trim());
          let finalText = "";
          let toolOutputs = [];
          let citationData = {}; // å­˜å‚¨å¼•ç”¨ä¿¡æ¯

          for (const line of lines) {
            // ç§»é™¤è¡Œå·å‰ç¼€ï¼ˆå¦‚ "8:"ï¼‰
            const cleanLine = line.replace(/^\d+:/, "");

            if (cleanLine.trim()) {
              try {
                const data = JSON.parse(cleanLine);
                console.log("è§£æçš„æ•°æ®:", data);

                // å¤„ç†æ•°ç»„æ ¼å¼çš„æ•°æ®
                if (Array.isArray(data)) {
                  for (const item of data) {
                    // æå–å·¥å…·è¾“å‡º - è¿™æ˜¯æœ€é‡è¦çš„å†…å®¹
                    if (item.tool_output && item.tool_output.content) {
                      toolOutputs.push(item.tool_output.content);
                      console.log("æ‰¾åˆ°å·¥å…·è¾“å‡º:", item.tool_output.content);
                    }

                    // æå–å“åº”æ–‡æœ¬å—
                    if (item.response && item.response.blocks) {
                      for (const block of item.response.blocks) {
                        if (block.block_type === "text" && block.text) {
                          finalText += block.text;
                        }
                      }
                    }

                    // æå–å¼•ç”¨ä¿¡æ¯ - å°è¯•å¤šç§å¯èƒ½çš„ç»“æ„
                    if (item.tool_output) {
                      // æ£€æŸ¥metadataä¸­çš„å¼•ç”¨
                      if (
                        item.tool_output.metadata &&
                        item.tool_output.metadata.citations
                      ) {
                        const metadata = item.tool_output.metadata;
                        for (const citation of metadata.citations) {
                          citationData[citation.id] = {
                            filename: citation.filename || citation.id,
                            content:
                              citation.content || citation.text || "æ— å†…å®¹é¢„è§ˆ",
                          };
                        }
                      }

                      // æ£€æŸ¥æ˜¯å¦æœ‰sourcesä¿¡æ¯
                      if (item.tool_output.sources) {
                        for (const source of item.tool_output.sources) {
                          if (source.id) {
                            citationData[source.id] = {
                              filename:
                                source.filename || source.name || source.id,
                              content:
                                source.content || source.text || "æ— å†…å®¹é¢„è§ˆ",
                            };
                          }
                        }
                      }

                      // å°è¯•ä»å†…å®¹ä¸­æå–å¼•ç”¨ä¿¡æ¯å’Œæ–‡æ¡£ç‰‡æ®µ
                      const content = item.tool_output.content;
                      if (content) {
                        // æŸ¥æ‰¾å¯èƒ½çš„æ–‡æ¡£å¼•ç”¨æ¨¡å¼
                        const docMatches = content.match(
                          /(?:æ¥æº|å¼•ç”¨|å‚è€ƒ)[:ï¼š]\s*([^\n]+)/g
                        );
                        if (docMatches) {
                          console.log("æ‰¾åˆ°æ–‡æ¡£å¼•ç”¨:", docMatches);
                        }

                        // å°è¯•æå–å¼•ç”¨IDå¯¹åº”çš„æ–‡æ¡£ç‰‡æ®µ
                        const citationMatches = content.match(
                          /\[citation:([a-f0-9-]+)\]/gi
                        );
                        if (citationMatches) {
                          for (const match of citationMatches) {
                            const citationId = match.match(
                              /\[citation:([a-f0-9-]+)\]/i
                            )[1];

                            // å°è¯•æ‰¾åˆ°è¿™ä¸ªå¼•ç”¨å‰åçš„æ–‡æœ¬ä½œä¸ºå†…å®¹é¢„è§ˆ
                            const citationIndex = content.indexOf(match);
                            if (citationIndex > -1) {
                              const beforeText = content.substring(
                                Math.max(0, citationIndex - 200),
                                citationIndex
                              );
                              const afterText = content.substring(
                                citationIndex + match.length,
                                citationIndex + match.length + 200
                              );
                              const contextText = beforeText + afterText;

                              if (!citationData[citationId]) {
                                citationData[citationId] = {};
                              }
                              citationData[citationId].content =
                                contextText.trim();
                              console.log(
                                "æå–å¼•ç”¨ä¸Šä¸‹æ–‡:",
                                citationId,
                                contextText.substring(0, 100) + "..."
                              );
                            }
                          }
                        }
                      }
                    }
                  }
                }
              } catch (e) {
                console.log("JSONè§£æå¤±è´¥:", cleanLine);
              }
            }
          }

          // ç›´æ¥ä½¿ç”¨å·¥å…·è¾“å‡ºï¼Œä¸è¿›è¡Œå¤æ‚å¤„ç†
          if (toolOutputs.length > 0) {
            // åªä½¿ç”¨æœ€åä¸€ä¸ªå·¥å…·è¾“å‡ºï¼ˆæœ€ç»ˆç»“æœï¼‰ï¼Œé¿å…é‡å¤
            finalText = toolOutputs[toolOutputs.length - 1].trim();
          }

          // å¦‚æœä»ç„¶æ²¡æœ‰æ–‡æœ¬ï¼Œå°è¯•è§£ç Unicode
          if (!finalText.trim()) {
            // è§£ç Unicodeå­—ç¬¦
            let decodedText = responseText.replace(
              /\\u([\da-f]{4})/gi,
              function (match, grp) {
                return String.fromCharCode(parseInt(grp, 16));
              }
            );

            console.log("è§£ç åçš„æ–‡æœ¬:", decodedText);

            // å°è¯•ä»è§£ç åçš„æ–‡æœ¬ä¸­æå–å†…å®¹
            const contentMatches = decodedText.match(/"content":\s*"([^"]+)"/g);
            if (contentMatches) {
              for (const match of contentMatches) {
                const content = match.match(/"content":\s*"([^"]+)"/)[1];
                if (
                  content &&
                  content.trim() &&
                  !content.includes("Calling tool")
                ) {
                  finalText += content + "\n";
                }
              }
            }
          }

          // ç®€å•å¤„ç†å¼•ç”¨æ ¼å¼ï¼Œä¸è¿›è¡Œå¤æ‚æ¸…ç†
          finalText = processSimpleCitations(finalText, citationData);

          return finalText.trim() || "æŠ±æ­‰ï¼ŒAIæ²¡æœ‰è¿”å›æœ‰æ•ˆçš„å›å¤ã€‚";
        } catch (error) {
          console.error("è§£æå“åº”å¤±è´¥:", error);
          return "æŠ±æ­‰ï¼Œè§£æAIå›å¤æ—¶å‡ºç°é”™è¯¯: " + error.message;
        }
      }

      // æ™ºèƒ½é€‰æ‹©æœ€ä½³å“åº”
      function selectBestResponse(toolOutputs) {
        if (toolOutputs.length === 1) {
          return cleanResponse(toolOutputs[0]);
        }

        // å¦‚æœæœ‰å¤šä¸ªå“åº”ï¼Œé€‰æ‹©æœ€å®Œæ•´çš„ä¸€ä¸ª
        let bestResponse = "";
        let maxLength = 0;

        for (const output of toolOutputs) {
          const cleaned = cleanResponse(output);

          // è·³è¿‡æ˜æ˜¾çš„é‡å¤æˆ–ç‰‡æ®µ
          if (
            cleaned.includes("Response 1:") ||
            cleaned.includes("Response 2:")
          ) {
            continue;
          }

          // é€‰æ‹©æœ€é•¿ä¸”æœ€å®Œæ•´çš„å“åº”
          if (cleaned.length > maxLength && !cleaned.includes("-----")) {
            maxLength = cleaned.length;
            bestResponse = cleaned;
          }
        }

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¥½çš„å“åº”ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¹¶æ¸…ç†
        if (!bestResponse) {
          bestResponse = cleanResponse(toolOutputs[0]);
        }

        return bestResponse;
      }

      // æ¸…ç†å“åº”å†…å®¹
      function cleanResponse(text) {
        if (!text) return "";

        // ç§»é™¤å“åº”æ ‡è®°å’Œåˆ†éš”ç¬¦
        let cleaned = text
          .replace(/Response \d+:\s*/g, "")
          .replace(/-{10,}/g, "")
          .replace(/^\s*[\r\n]+/gm, "")
          .trim();

        // ç§»é™¤é‡å¤çš„æ®µè½
        cleaned = removeDuplicateParagraphs(cleaned);

        return cleaned.trim();
      }

      // ç§»é™¤é‡å¤çš„æ®µè½
      function removeDuplicateParagraphs(text) {
        const paragraphs = text.split(/\n\s*\n/);
        const uniqueParagraphs = [];
        const seen = new Set();

        for (const paragraph of paragraphs) {
          const normalized = paragraph.replace(/\s+/g, " ").trim();

          // è·³è¿‡å¤ªçŸ­çš„æ®µè½
          if (normalized.length < 20) continue;

          // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç›¸ä¼¼çš„æ®µè½
          let isDuplicate = false;
          for (const seenParagraph of seen) {
            if (calculateSimilarity(normalized, seenParagraph) > 0.8) {
              isDuplicate = true;
              break;
            }
          }

          if (!isDuplicate) {
            seen.add(normalized);
            uniqueParagraphs.push(paragraph);
          }
        }

        return uniqueParagraphs.join("\n\n");
      }

      // è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦
      function calculateSimilarity(str1, str2) {
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;

        if (longer.length === 0) return 1.0;

        const editDistance = levenshteinDistance(longer, shorter);
        return (longer.length - editDistance) / longer.length;
      }

      // è®¡ç®—ç¼–è¾‘è·ç¦»
      function levenshteinDistance(str1, str2) {
        const matrix = [];

        for (let i = 0; i <= str2.length; i++) {
          matrix[i] = [i];
        }

        for (let j = 0; j <= str1.length; j++) {
          matrix[0][j] = j;
        }

        for (let i = 1; i <= str2.length; i++) {
          for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j] + 1
              );
            }
          }
        }

        return matrix[str2.length][str1.length];
      }

      // æ¸…ç†å¼•ç”¨æ ¼å¼
      function cleanCitationFormats(text) {
        // ç§»é™¤é”™è¯¯çš„å¼•ç”¨æ ¼å¼ï¼Œå¦‚ "è´¢åŠ¡æ–‡æ¡£-866da74c.txt" è¿™æ ·çš„æ–‡æœ¬
        text = text.replace(/è´¢åŠ¡æ–‡æ¡£-[a-f0-9]{8}\.txt/g, "");

        // ç§»é™¤é”™è¯¯çš„å¼•ç”¨å—æ ¼å¼ï¼Œå¦‚ "ğŸ“„ è´¢åŠ¡æ–‡æ¡£-866da74cã€‚"
        text = text.replace(/ğŸ“„\s*è´¢åŠ¡æ–‡æ¡£-[a-f0-9]{8}[ã€‚\.]/g, "");

        // æ¸…ç†é‡å¤çš„å†…å®¹ç‰‡æ®µ
        text = text.replace(/(.{50,}?)\1+/g, "$1");

        // ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
        text = text.replace(/\n\s*\n\s*\n/g, "\n\n");

        return text.trim();
      }

      // æ–‡æ¡£åæ˜ å°„ - æ ¹æ®å¼•ç”¨IDæ˜ å°„åˆ°çœŸå®çš„txtæ–‡ä»¶å
      function getDocumentName(citationId, citationData) {
        // å¦‚æœæœ‰å…·ä½“çš„å¼•ç”¨æ•°æ®ï¼Œä½¿ç”¨å®ƒ
        if (citationData[citationId] && citationData[citationId].filename) {
          return citationData[citationId].filename;
        }

        // æ ¹æ®å¼•ç”¨IDçš„å‰å‡ ä½æ˜ å°„åˆ°å®é™…çš„txtæ–‡ä»¶
        const shortId = citationId.substring(0, 8);

        // çœŸå®çš„txtæ–‡ä»¶åæ˜ å°„
        const txtFileMap = {
          fa70e709: "å¸¸è§é—®é¢˜ç±»-09_å­˜è´§ç›˜ç‚¹å·®å¼‚å¤„ç†æ–¹æ³•.txt",
          d30c0ba4: "å¸¸è§é—®é¢˜ç±»-09_å­˜è´§ç›˜ç‚¹å·®å¼‚å¤„ç†æ–¹æ³•.txt",
          "866da74c": "å¸¸è§é—®é¢˜ç±»-16_æˆæœ¬æ ¸ç®—æ–¹æ³•é€‰æ‹©ä¸åº”ç”¨.txt",
          // å¯ä»¥æ ¹æ®å®é™…çš„å¼•ç”¨IDæ·»åŠ æ›´å¤šæ˜ å°„
          // ä¾‹å¦‚ï¼š
          // 'abc12345': 'å¸¸è§é—®é¢˜ç±»-01_å‘ç¥¨ä¸¢å¤±å¤„ç†æµç¨‹åŠè¡¥æ•‘æªæ–½.txt',
          // 'def67890': 'å¸¸è§é—®é¢˜ç±»-02_å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨è®¤è¯é€¾æœŸå¤„ç†æ–¹æ³•.txt',
        };

        return txtFileMap[shortId] || "è´¢åŠ¡æ–‡æ¡£-" + shortId + ".txt";
      }

      // ç®€åŒ–çš„å¼•ç”¨å¤„ç†å‡½æ•°
      function processSimpleCitations(text, citationData) {
        // åŒ¹é…å¼•ç”¨æ ¼å¼ [citation:id]
        const citationRegex = /\[\s*citation:\s*([a-f0-9-]+)\s*\]/gi;

        return text.replace(citationRegex, function (match, citationId) {
          // è·å–æ–‡æ¡£å
          const filename = getDocumentName(citationId, citationData);

          // ç®€åŒ–çš„å†…å®¹æè¿°
          const content = "ğŸ“„ " + filename + "\n\nç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯";

          // ç®€åŒ–æ˜¾ç¤ºçš„æ–‡ä»¶åï¼ˆå»æ‰.txtåç¼€å’Œç¼–å·å‰ç¼€ï¼‰
          const displayName = filename
            .replace(/^å¸¸è§é—®é¢˜ç±»-\d+_/, "")
            .replace(/\.txt$/, "");

          return (
            '<span class="citation" data-citation-id="' +
            citationId +
            '" onclick="showCitationDetails(\'' +
            citationId +
            "', '" +
            filename +
            "')\">" +
            '<span class="citation-tooltip">' +
            filename +
            "</span>" +
            '<span class="citation-content">' +
            escapeHtml(content) +
            "</span>" +
            "ğŸ“„ " +
            displayName +
            "</span>"
          );
        });
      }

      // æ˜¾ç¤ºå¼•ç”¨è¯¦æƒ…ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
      function showCitationDetails(citationId, filename) {
        console.log("ç‚¹å‡»äº†å¼•ç”¨:", citationId, filename);

        // æ˜¾ç¤ºtxtæ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯
        const displayName = filename
          .replace(/^å¸¸è§é—®é¢˜ç±»-\d+_/, "")
          .replace(/\.txt$/, "");

        const message =
          "ğŸ“„ TXTæ–‡æ¡£å¼•ç”¨è¯¦æƒ…\n\n" +
          "æ–‡æ¡£åç§°: " +
          displayName +
          "\n" +
          "å®Œæ•´æ–‡ä»¶å: " +
          filename +
          "\n" +
          "å¼•ç”¨ID: " +
          citationId +
          "\n\n" +
          "è¿™æ˜¯ä»è´¢åŠ¡çŸ¥è¯†åº“çš„txtæ–‡ä»¶ä¸­å¼•ç”¨çš„ç›¸å…³å†…å®¹ã€‚\n" +
          "è¯¥æ–‡æ¡£åŒ…å«äº†è¯¦ç»†çš„æ“ä½œæµç¨‹å’Œè§„èŒƒè¯´æ˜ã€‚\n\n" +
          "ğŸ’¡ æç¤ºï¼šé¼ æ ‡æ‚¬æµ®åœ¨å¼•ç”¨å—ä¸Šå¯ä»¥æŸ¥çœ‹å†…å®¹é¢„è§ˆ";

        alert(message);

        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šäº¤äº’åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š
        // 1. å¼¹å‡ºæ¨¡æ€çª—å£æ˜¾ç¤ºå®Œæ•´æ–‡æ¡£å†…å®¹
        // 2. å‘é€APIè¯·æ±‚è·å–txtæ–‡ä»¶çš„å®Œæ•´å†…å®¹
        // 3. é«˜äº®æ˜¾ç¤ºå¼•ç”¨çš„å…·ä½“æ®µè½
      }

      // æ–‡ä»¶ä¸Šä¼ å¤„ç†
      async function handleFileUpload(event) {
        const files = Array.from(event.target.files);

        for (const file of files) {
          try {
            showLoading("æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...");
            const uploadedFile = await uploadFile(file);
            uploadedFiles.push(uploadedFile);
            displayUploadedFile(uploadedFile);
            addMessage("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: " + file.name, "bot");
          } catch (error) {
            console.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥:", error);
            addMessage("æ–‡ä»¶ä¸Šä¼ å¤±è´¥: " + error.message, "bot");
          } finally {
            hideLoading();
          }
        }

        fileInput.value = "";
      }

      async function uploadFile(file) {
        const reader = new FileReader();

        return new Promise((resolve, reject) => {
          reader.onload = async function (e) {
            try {
              const base64 = e.target.result.split(",")[1];

              const response = await fetch("/api/chat/file", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  name: file.name,
                  base64: base64,
                  params: JSON.stringify({
                    size: file.size,
                    type: file.type,
                  }),
                }),
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(
                  "ä¸Šä¼ å¤±è´¥: " + response.status + " - " + errorText
                );
              }

              const result = await response.json();
              resolve(result);
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = function () {
            reject(new Error("æ–‡ä»¶è¯»å–å¤±è´¥"));
          };
          reader.readAsDataURL(file);
        });
      }

      function displayUploadedFile(file) {
        const fileTag = document.createElement("div");
        fileTag.className = "file-tag";
        fileTag.innerHTML =
          "ğŸ“„ " +
          file.id +
          ' <span class="remove-file" onclick="removeFile(\'' +
          file.id +
          "')\">&times;</span>";
        uploadedFilesDiv.appendChild(fileTag);
      }

      function removeFile(fileId) {
        uploadedFiles = uploadedFiles.filter((f) => f.id !== fileId);
        updateUploadedFilesDisplay();
      }

      function updateUploadedFilesDisplay() {
        uploadedFilesDiv.innerHTML = "";
        uploadedFiles.forEach((file) => displayUploadedFile(file));
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
      function addMessage(text, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message " + sender + "-message";

        // å¦‚æœæ˜¯botæ¶ˆæ¯ä¸”åŒ…å«å¼•ç”¨ï¼Œåˆ™å…è®¸HTMLï¼›å¦åˆ™è½¬ä¹‰HTML
        let content;
        if (sender === "bot" && text.includes('<span class="citation"')) {
          content = text; // å…è®¸å¼•ç”¨HTML
        } else {
          content = escapeHtml(text); // è½¬ä¹‰å…¶ä»–å†…å®¹
        }

        messageDiv.innerHTML =
          '<div class="message-content">' + content + "</div>";
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showLoading(text) {
        if (!text) text = "AIæ­£åœ¨æ€è€ƒä¸­...";
        addMessage(text, "bot");
        sendBtn.disabled = true;
      }

      function hideLoading() {
        sendBtn.disabled = false;
      }
    </script>
  </body>
</html>
