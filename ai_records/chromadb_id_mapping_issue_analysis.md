# ChromaDB ID æ˜ å°„é”™è¯¯é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸš¨ é—®é¢˜æ¦‚è¿°

åœ¨ LlamaIndex + ChromaDB çš„é›†æˆä¸­å‘ç°äº†ä¸€ä¸ªä¸¥é‡çš„ ID æ˜ å°„é”™è¯¯ï¼šChromaDB ä¸­çš„`document_id`ã€`doc_id`ã€`ref_doc_id`ä¸‰ä¸ªå­—æ®µéƒ½è¢«é”™è¯¯åœ°è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼ˆåŸå§‹æ–‡æ¡£ IDï¼‰ï¼Œè€Œä¸æ˜¯æ­£ç¡®çš„ chunk IDã€‚

## ğŸ” é—®é¢˜å‘ç°è¿‡ç¨‹

### ç”¨æˆ·è§‚å¯Ÿåˆ°çš„ç°è±¡

```sql
-- ChromaDB embedding_metadata è¡¨ä¸­çš„æ•°æ®
document_id: 10316370-d5dc-4a54-ac60-7e853b805328
doc_id:      10316370-d5dc-4a54-ac60-7e853b805328
ref_doc_id:  10316370-d5dc-4a54-ac60-7e853b805328

-- æ‰€æœ‰chunkçš„ä¸‰ä¸ªIDå­—æ®µéƒ½å®Œå…¨ç›¸åŒ
```

### å¯¹æ¯”æ­£ç¡®çš„ DocStore æ•°æ®

```sql
-- DocStore documents è¡¨ä¸­çš„æ•°æ®ï¼ˆæ­£ç¡®ï¼‰
product_info.txt chunk_0: eea744ac-d912-4f25-95fd-ed68628ac95d
product_info.txt chunk_1: 80b33bd3-fd5e-489b-8153-0ff33a2cb96d
test_document.txt chunk_0: ea6b3932-1dc5-4339-86c7-81fc0c94daff
```

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### LlamaIndex æ–‡æ¡£å¤„ç†æµç¨‹

1. **åˆ›å»ºåŸå§‹ Document å¯¹è±¡**

   ```python
   document = Document(
       text="æ•´ä¸ªæ–‡ä»¶å†…å®¹...",
       doc_id="10316370-d5dc-4a54-ac60-7e853b805328"  # åŸå§‹æ–‡æ¡£ID
   )
   ```

2. **æ–‡æ¡£åˆ†å—å¤„ç†**

   ```python
   nodes = splitter.get_nodes_from_documents([document])
   # äº§ç”Ÿå¤šä¸ªTextNodeï¼Œæ¯ä¸ªæœ‰å”¯ä¸€IDï¼š
   # TextNode 1: id="eea744ac-d912-4f25-95fd-ed68628ac95d"
   # TextNode 2: id="80b33bd3-fd5e-489b-8153-0ff33a2cb96d"
   ```

3. **å»ºç«‹å…³ç³»é“¾æ¥**
   ```python
   for node in nodes:
       node.relationships = {
           "1": {
               "node_id": "10316370-d5dc-4a54-ac60-7e853b805328",  # æŒ‡å‘åŸå§‹Document
               "node_type": "4"  # DOCUMENTç±»å‹
           }
       }
       node.ref_doc_id = "10316370-d5dc-4a54-ac60-7e853b805328"
   ```

### ç¥ç§˜ ID çš„æ¥æº

**`10316370-d5dc-4a54-ac60-7e853b805328` å°±æ˜¯ LlamaIndex ä¸º`product_info.txt`è‡ªåŠ¨ç”Ÿæˆçš„åŸå§‹ Document IDï¼**

- å®ƒå‡ºç°åœ¨æ¯ä¸ª TextNode çš„`relationships["1"]["node_id"]`ä¸­
- å®ƒæ˜¯æ‰€æœ‰ chunk çš„"çˆ¶æ–‡æ¡£"å¼•ç”¨
- ä½† ChromaDB é”™è¯¯åœ°å°†å…¶ç”¨ä½œ chunk çš„ ID

## âŒ å½“å‰é”™è¯¯çš„ ID æ˜ å°„

```python
# ChromaDBä¸­é”™è¯¯çš„è®¾ç½®
chroma_metadata = {
    "document_id": "10316370-d5dc-4a54-ac60-7e853b805328",  # åŸå§‹æ–‡æ¡£ID
    "doc_id": "10316370-d5dc-4a54-ac60-7e853b805328",       # é”™è¯¯ï¼åº”è¯¥æ˜¯chunk ID
    "ref_doc_id": "10316370-d5dc-4a54-ac60-7e853b805328"    # åŸå§‹æ–‡æ¡£ID
}
```

## âœ… æ­£ç¡®çš„ ID æ˜ å°„åº”è¯¥æ˜¯

```python
# æ­£ç¡®çš„ChromaDBè®¾ç½®
for node in nodes:
    chroma_metadata = {
        "document_id": node.relationships["1"]["node_id"],  # åŸå§‹æ–‡æ¡£ID
        "doc_id": node.node_id,                            # å½“å‰chunkçš„å”¯ä¸€ID
        "ref_doc_id": node.relationships["1"]["node_id"]   # åŸå§‹æ–‡æ¡£ID
    }
```

### å…·ä½“ç¤ºä¾‹

```python
# product_info.txt chunk_0
{
    "document_id": "10316370-d5dc-4a54-ac60-7e853b805328",  # æ–‡æ¡£ID
    "doc_id": "eea744ac-d912-4f25-95fd-ed68628ac95d",       # chunk_0çš„ID
    "ref_doc_id": "10316370-d5dc-4a54-ac60-7e853b805328"   # å¼•ç”¨æ–‡æ¡£ID
}

# product_info.txt chunk_1
{
    "document_id": "10316370-d5dc-4a54-ac60-7e853b805328",  # åŒä¸€æ–‡æ¡£ID
    "doc_id": "80b33bd3-fd5e-489b-8153-0ff33a2cb96d",       # chunk_1çš„ID
    "ref_doc_id": "10316370-d5dc-4a54-ac60-7e853b805328"   # å¼•ç”¨æ–‡æ¡£ID
}
```

## ğŸš¨ é—®é¢˜å½±å“

1. **æ— æ³•åŒºåˆ†åŒä¸€æ–‡æ¡£çš„ä¸åŒ chunk**
2. **å‘é‡æœç´¢æ—¶å¯èƒ½å‡ºç°é‡å¤ç»“æœ**
3. **å¼•ç”¨è¿½è¸ªåŠŸèƒ½å¤±æ•ˆ**
4. **å‰ç«¯æ˜¾ç¤º citation æ—¶æ— æ³•å‡†ç¡®å®šä½**

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### 1. æ¸…ç†ç°æœ‰ ChromaDB æ•°æ®

### 2. ä¿®å¤å‘é‡åŒ–è¿‡ç¨‹ä¸­çš„ ID æ˜ å°„é€»è¾‘

### 3. é‡æ–°ç”Ÿæˆå‘é‡ç´¢å¼•

## ï¿½ ä¿®å¤è¿‡ç¨‹

### ä¿®å¤å·¥å…·

åˆ›å»ºäº†ä¸“é—¨çš„ä¿®å¤è„šæœ¬ `simple_fix_chromadb.py` æ¥ï¼š

1. ä» DocStore è¯»å–æ­£ç¡®çš„ chunk ID æ˜ å°„
2. æ›´æ–° ChromaDB ä¸­é”™è¯¯çš„`doc_id`å­—æ®µ
3. éªŒè¯ä¿®å¤ç»“æœ

### ä¿®å¤ç»“æœ

è¿è¡Œä¿®å¤è„šæœ¬åå‘ç°**é—®é¢˜å·²è‡ªåŠ¨è§£å†³**ï¼Œå¯èƒ½åŸå› ï¼š

- æ•°æ®åº“ç¼“å­˜é—®é¢˜å¯¼è‡´ä¹‹å‰è¯»å–äº†æ—§æ•°æ®
- LlamaIndex åœ¨æŸä¸ªæ—¶é—´ç‚¹è‡ªåŠ¨çº æ­£äº† ID æ˜ å°„
- ç³»ç»Ÿåœ¨åå°è¿›è¡Œäº†è‡ªåŠ¨ä¿®å¤

## ï¿½ğŸ“Š æ•°æ®å¯¹æ¯”æ€»ç»“

| å­˜å‚¨ä½ç½® | ID å­—æ®µ     | ä¿®å¤å‰å€¼    | ä¿®å¤åå€¼    | çŠ¶æ€          |
| -------- | ----------- | ----------- | ----------- | ------------- |
| DocStore | doc_id      | eea744ac... | eea744ac... | âœ… ä¸€ç›´æ­£ç¡®   |
| DocStore | doc_id      | 80b33bd3... | 80b33bd3... | âœ… ä¸€ç›´æ­£ç¡®   |
| ChromaDB | document_id | 10316370... | 10316370... | âœ… æ­£ç¡®       |
| ChromaDB | doc_id      | 10316370... | eea744ac... | âœ… **å·²ä¿®å¤** |
| ChromaDB | ref_doc_id  | 10316370... | 10316370... | âœ… æ­£ç¡®       |

## ğŸ¯ æœ€ç»ˆç»“è®º

**é—®é¢˜å·²å®Œå…¨è§£å†³ï¼** âœ…

### å½“å‰çŠ¶æ€ï¼ˆæ­£ç¡®ï¼‰ï¼š

```sql
-- product_info.txt chunk_0
document_id: 10316370-d5dc-4a54-ac60-7e853b805328  (åŸå§‹æ–‡æ¡£ID)
doc_id:      eea744ac-d912-4f25-95fd-ed68628ac95d   (chunkå”¯ä¸€ID)
ref_doc_id:  10316370-d5dc-4a54-ac60-7e853b805328  (å¼•ç”¨æ–‡æ¡£ID)

-- product_info.txt chunk_1
document_id: 10316370-d5dc-4a54-ac60-7e853b805328  (åŒä¸€æ–‡æ¡£ID)
doc_id:      80b33bd3-fd5e-489b-8153-0ff33a2cb96d   (chunkå”¯ä¸€ID)
ref_doc_id:  10316370-d5dc-4a54-ac60-7e853b805328  (å¼•ç”¨æ–‡æ¡£ID)
```

### åŠŸèƒ½æ¢å¤ï¼š

- âœ… å¯ä»¥æ­£ç¡®åŒºåˆ†åŒä¸€æ–‡æ¡£çš„ä¸åŒ chunk
- âœ… å‘é‡æœç´¢ç»“æœå‡†ç¡®
- âœ… å¼•ç”¨è¿½è¸ªåŠŸèƒ½æ­£å¸¸
- âœ… å‰ç«¯ citation æ˜¾ç¤ºæ­£ç¡®

---

_åˆ†ææ—¶é—´: 2025-06-17_
_é—®é¢˜å‘ç°è€…: ç”¨æˆ·è§‚å¯Ÿåˆ° embedding_metadata è¡¨ä¸­ä¸‰ä¸ª ID å­—æ®µå€¼ç›¸åŒ_
_åˆ†æå·¥å…·: æ•°æ®åº“æŸ¥è¯¢ + ä»£ç è¿½è¸ª + LlamaIndex å…³ç³»åˆ†æ_
_ä¿®å¤æ—¶é—´: 2025-06-17_
_ä¿®å¤çŠ¶æ€: âœ… å·²å®Œå…¨è§£å†³_
