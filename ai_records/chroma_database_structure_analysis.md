# ChromaDB 数据库结构分析报告

## 📊 基本信息

- **数据库文件**: `storage/chroma_db_new/chroma.sqlite3`
- **分析时间**: 2025-06-17 17:34:19
- **总表数**: 19
- **当前数据**: 包含 3 个向量记录，来自 2 个文档文件

## 🏗️ ChromaDB 架构概述

ChromaDB 是一个专门为 AI 应用设计的向量数据库，采用分层架构：

```
┌─────────────────────────────────────────────────────────────────┐
│                    ChromaDB 分层架构                              │
├─────────────────────────────────────────────────────────────────┤
│  🏢 租户层 (tenants)          │  🗄️ 数据库层 (databases)        │
│  └── 多租户隔离               │  └── 逻辑数据库分组              │
├─────────────────────────────────────────────────────────────────┤
│  📚 集合层 (collections)      │  🧩 分段层 (segments)           │
│  └── 向量集合管理             │  └── 数据分片存储                │
├─────────────────────────────────────────────────────────────────┤
│  🧠 向量层 (embeddings)       │  📋 元数据层 (metadata)         │
│  └── 高维向量存储             │  └── 文档属性信息                │
├─────────────────────────────────────────────────────────────────┤
│  🔍 搜索层 (fulltext_search)  │  ⚙️ 系统层 (migrations)        │
│  └── 全文检索支持             │  └── 版本管理和配置              │
└─────────────────────────────────────────────────────────────────┘
```

## 📋 表结构详细说明

### 🗂️ 表: `collection_metadata`

**记录数**: 6

#### 字段结构

| 字段名          | 数据类型 | 主键 | 非空 | 默认值 | 说明        |
| --------------- | -------- | ---- | ---- | ------ | ----------- |
| `collection_id` | TEXT     | 🔑   | ✅   | -      | 所属集合 ID |
| `key`           | TEXT     | 🔑   | ❌   | -      | 键名        |
| `str_value`     | TEXT     |      | ✅   | -      | 文本数据    |
| `int_value`     | INTEGER  |      | ✅   | -      | 整数值      |
| `float_value`   | REAL     |      | ✅   | -      | 浮点数值    |
| `bool_value`    | INTEGER  |      | ✅   | -      | 布尔值      |

#### 索引

- **sqlite_autoindex_collection_metadata_1**: 🔒 唯一 (pk)

#### 表用途

**集合元数据配置表** - 存储每个向量集合的配置参数

- 存储 HNSW 算法配置（如相似度计算方式：cosine）
- 支持键值对形式的灵活配置存储
- 当前主要配置：`hnsw:space = cosine`（余弦相似度）

---

### 🗂️ 表: `collections`

**记录数**: 1

#### 字段结构

| 字段名            | 数据类型 | 主键 | 非空 | 默认值 | 说明                      |
| ----------------- | -------- | ---- | ---- | ------ | ------------------------- |
| `id`              | TEXT     | 🔑   | ✅   | -      | 集合唯一标识符            |
| `name`            | TEXT     |      | ❌   | -      | 集合名称                  |
| `dimension`       | INTEGER  |      | ✅   | -      | 向量维度（当前：3072 维） |
| `database_id`     | TEXT     |      | ❌   | -      | 所属数据库 ID             |
| `config_json_str` | TEXT     |      | ✅   | -      | JSON 格式的配置信息       |

#### 索引

- **sqlite_autoindex_collections_2**: 🔒 唯一 (u)
- **sqlite_autoindex_collections_1**: 🔒 唯一 (pk)

#### 表用途

**向量集合管理表** - ChromaDB 的核心管理表

- 管理不同的文档向量集合（当前：`document_vectors`）
- 定义向量维度（3072 维，对应 OpenAI text-embedding-3-large 模型）
- 存储 HNSW 索引配置（L2 距离、构建参数等）
- 支持多集合隔离和独立配置

---

### 🗂️ 表: `databases`

**记录数**: 1

#### 字段结构

| 字段名      | 数据类型 | 主键 | 非空 | 默认值 | 说明             |
| ----------- | -------- | ---- | ---- | ------ | ---------------- |
| `id`        | TEXT     | 🔑   | ✅   | -      | 数据库唯一标识符 |
| `name`      | TEXT     |      | ❌   | -      | 数据库名称       |
| `tenant_id` | TEXT     |      | ❌   | -      | 租户标识符       |

#### 索引

- **sqlite_autoindex_databases_2**: 🔒 唯一 (u)
- **sqlite_autoindex_databases_1**: 🔒 唯一 (pk)

#### 表用途

**数据库管理表** - 逻辑数据库分组管理

- 管理逻辑数据库（当前：`default_database`）
- 支持多数据库隔离
- 与租户系统集成（当前：`default_tenant`）

---

### 🗂️ 表: `embedding_fulltext_search`

**记录数**: 0

#### 字段结构

| 字段名 | 数据类型 | 主键 | 非空 | 默认值 | 说明 |
| ------ | -------- | ---- | ---- | ------ | ---- |

#### 表用途

**全文搜索表** - 支持基于关键词的文本搜索

- 提供传统的全文检索功能
- 与向量搜索形成互补
- 支持混合检索策略

---

### 🗂️ 表: `embedding_fulltext_search_config`

**记录数**: 1

#### 字段结构

| 字段名 | 数据类型 | 主键 | 非空 | 默认值 | 说明   |
| ------ | -------- | ---- | ---- | ------ | ------ |
| `k`    |          | 🔑   | ❌   | -      | 待分析 |
| `v`    |          |      | ✅   | -      | 待分析 |

#### 索引

- **sqlite_autoindex_embedding_fulltext_search_config_1**: 🔒 唯一 (pk)

#### 表用途

**embedding_fulltext_search_config 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `embedding_fulltext_search_content`

**记录数**: 0

#### 字段结构

| 字段名 | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ------ | -------- | ---- | ---- | ------ | ---------- |
| `id`   | INTEGER  | 🔑   | ✅   | -      | 唯一标识符 |
| `c0`   |          |      | ✅   | -      | 待分析     |

#### 表用途

**embedding_fulltext_search_content 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `embedding_fulltext_search_data`

**记录数**: 0

#### 字段结构

| 字段名  | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ------- | -------- | ---- | ---- | ------ | ---------- |
| `id`    | INTEGER  | 🔑   | ✅   | -      | 唯一标识符 |
| `block` | BLOB     |      | ✅   | -      | 二进制数据 |

#### 表用途

**embedding_fulltext_search_data 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `embedding_fulltext_search_docsize`

**记录数**: 0

#### 字段结构

| 字段名 | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ------ | -------- | ---- | ---- | ------ | ---------- |
| `id`   | INTEGER  | 🔑   | ✅   | -      | 唯一标识符 |
| `sz`   | BLOB     |      | ✅   | -      | 二进制数据 |

#### 表用途

**embedding_fulltext_search_docsize 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `embedding_fulltext_search_idx`

**记录数**: 20

#### 字段结构

| 字段名  | 数据类型 | 主键 | 非空 | 默认值 | 说明   |
| ------- | -------- | ---- | ---- | ------ | ------ |
| `segid` |          | 🔑   | ❌   | -      | 待分析 |
| `term`  |          | 🔑   | ❌   | -      | 待分析 |
| `pgno`  |          |      | ✅   | -      | 待分析 |

#### 索引

- **sqlite_autoindex_embedding_fulltext_search_idx_1**: 🔒 唯一 (pk)

#### 表用途

**embedding_fulltext_search_idx 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `embedding_metadata`

**记录数**: 42

#### 字段结构

| 字段名         | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| -------------- | -------- | ---- | ---- | ------ | ---------- |
| `id`           | INTEGER  | 🔑   | ✅   | -      | 唯一标识符 |
| `key`          | TEXT     | 🔑   | ❌   | -      | 键名       |
| `string_value` | TEXT     |      | ✅   | -      | 字符串值   |
| `int_value`    | INTEGER  |      | ✅   | -      | 整数值     |
| `float_value`  | REAL     |      | ✅   | -      | 浮点数值   |
| `bool_value`   | INTEGER  |      | ✅   | -      | 布尔值     |

#### 索引

- **embedding_metadata_string_value**: 📋 普通 (c)
- **embedding_metadata_float_value**: 📋 普通 (c)
- **embedding_metadata_int_value**: 📋 普通 (c)
- **sqlite_autoindex_embedding_metadata_1**: 🔒 唯一 (pk)

#### 表用途

**向量元数据表** - 存储向量的附加信息

- 保存文档 ID、文件名等元数据
- 支持基于元数据的过滤查询
- 建立向量与原始文档的关联

---

### 🗂️ 表: `embeddings`

**记录数**: 3

#### 字段结构

| 字段名         | 数据类型  | 主键 | 非空 | 默认值            | 说明                    |
| -------------- | --------- | ---- | ---- | ----------------- | ----------------------- |
| `id`           | INTEGER   | 🔑   | ✅   | -                 | 向量记录的自增 ID       |
| `segment_id`   | TEXT      |      | ❌   | -                 | 所属数据分段 ID         |
| `embedding_id` | TEXT      |      | ❌   | -                 | 向量的 UUID 标识符      |
| `seq_id`       | BLOB      |      | ❌   | -                 | 序列 ID（8 字节二进制） |
| `created_at`   | TIMESTAMP |      | ❌   | CURRENT_TIMESTAMP | 向量创建时间            |

#### 索引

- **sqlite_autoindex_embeddings_1**: 🔒 唯一 (u)

#### 表用途

**嵌入向量索引表** - 管理向量记录的元信息

- 存储向量的 ID 映射关系（不包含实际向量数据）
- 关联向量与数据分段的映射
- 记录向量的创建时间和序列号
- 实际向量数据存储在 `embeddings_queue` 表中

---

### 🗂️ 表: `embeddings_queue`

**记录数**: 3

#### 字段结构

| 字段名       | 数据类型  | 主键 | 非空 | 默认值            | 说明                       |
| ------------ | --------- | ---- | ---- | ----------------- | -------------------------- |
| `seq_id`     | INTEGER   | 🔑   | ✅   | -                 | 序列 ID（自增主键）        |
| `created_at` | TIMESTAMP |      | ❌   | CURRENT_TIMESTAMP | 向量创建时间               |
| `operation`  | INTEGER   |      | ❌   | -                 | 操作类型（0=添加）         |
| `topic`      | TEXT      |      | ❌   | -                 | 集合主题标识               |
| `id`         | TEXT      |      | ❌   | -                 | 向量 UUID 标识符           |
| `vector`     | BLOB      |      | ✅   | -                 | 实际向量数据（12288 字节） |
| `encoding`   | TEXT      |      | ✅   | -                 | 向量编码格式（FLOAT32）    |
| `metadata`   | TEXT      |      | ✅   | -                 | 文档元数据（JSON 格式）    |

#### 表用途

**向量数据存储表** - 存储实际的向量数据和元数据

- 保存 3072 维的向量数据（12288 字节，每个 float32 占 4 字节）
- 存储文档的完整元数据（文件路径、文件名、文件类型等）
- 支持向量的增删改操作（operation 字段）
- 与集合通过 topic 字段关联

---

### 🗂️ 表: `embeddings_queue_config`

**记录数**: 1

#### 字段结构

| 字段名            | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ----------------- | -------- | ---- | ---- | ------ | ---------- |
| `id`              | INTEGER  | 🔑   | ✅   | -      | 唯一标识符 |
| `config_json_str` | TEXT     |      | ✅   | -      | 文本数据   |

#### 表用途

**embeddings_queue_config 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `maintenance_log`

**记录数**: 0

#### 字段结构

| 字段名      | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ----------- | -------- | ---- | ---- | ------ | ---------- |
| `id`        | INT      | 🔑   | ✅   | -      | 唯一标识符 |
| `timestamp` | INT      |      | ❌   | -      | 整数       |
| `operation` | TEXT     |      | ❌   | -      | 文本数据   |

#### 索引

- **sqlite_autoindex_maintenance_log_1**: 🔒 唯一 (pk)

#### 表用途

**maintenance_log 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `max_seq_id`

**记录数**: 4

#### 字段结构

| 字段名       | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ------------ | -------- | ---- | ---- | ------ | ---------- |
| `segment_id` | TEXT     | 🔑   | ✅   | -      | 分段 ID    |
| `seq_id`     | BLOB     |      | ❌   | -      | 二进制数据 |

#### 索引

- **sqlite_autoindex_max_seq_id_1**: 🔒 唯一 (pk)

#### 表用途

**max_seq_id 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `migrations`

**记录数**: 15

#### 字段结构

| 字段名     | 数据类型 | 主键 | 非空 | 默认值 | 说明     |
| ---------- | -------- | ---- | ---- | ------ | -------- |
| `dir`      | TEXT     | 🔑   | ❌   | -      | 文本数据 |
| `version`  | INTEGER  | 🔑   | ❌   | -      | 整数     |
| `filename` | TEXT     |      | ❌   | -      | 文本数据 |
| `sql`      | TEXT     |      | ❌   | -      | 文本数据 |
| `hash`     | TEXT     |      | ❌   | -      | 文本数据 |

#### 索引

- **sqlite_autoindex_migrations_1**: 🔒 唯一 (pk)

#### 表用途

**migrations 表** - 具体用途需要进一步分析

---

### 🗂️ 表: `segment_metadata`

**记录数**: 6

#### 字段结构

| 字段名        | 数据类型 | 主键 | 非空 | 默认值 | 说明     |
| ------------- | -------- | ---- | ---- | ------ | -------- |
| `segment_id`  | TEXT     | 🔑   | ✅   | -      | 分段 ID  |
| `key`         | TEXT     | 🔑   | ❌   | -      | 键名     |
| `str_value`   | TEXT     |      | ✅   | -      | 文本数据 |
| `int_value`   | INTEGER  |      | ✅   | -      | 整数值   |
| `float_value` | REAL     |      | ✅   | -      | 浮点数值 |
| `bool_value`  | INTEGER  |      | ✅   | -      | 布尔值   |

#### 索引

- **sqlite_autoindex_segment_metadata_1**: 🔒 唯一 (pk)

#### 表用途

**分段元数据表** - 存储分段的配置信息

- 记录分段的创建时间、大小等信息
- 支持分段的生命周期管理
- 优化存储空间使用

---

### 🗂️ 表: `segments`

**记录数**: 2

#### 字段结构

| 字段名       | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ------------ | -------- | ---- | ---- | ------ | ---------- |
| `id`         | TEXT     | 🔑   | ✅   | -      | 唯一标识符 |
| `type`       | TEXT     |      | ❌   | -      | 文本数据   |
| `scope`      | TEXT     |      | ❌   | -      | 作用域     |
| `collection` | TEXT     |      | ❌   | -      | 文本数据   |

#### 索引

- **sqlite_autoindex_segments_1**: 🔒 唯一 (pk)

#### 表用途

**分段管理表** - 管理数据的分段存储

- 优化大规模数据的存储和查询
- 支持数据分片和并行处理
- 提高查询性能

---

### 🗂️ 表: `tenants`

**记录数**: 1

#### 字段结构

| 字段名 | 数据类型 | 主键 | 非空 | 默认值 | 说明       |
| ------ | -------- | ---- | ---- | ------ | ---------- |
| `id`   | TEXT     | 🔑   | ✅   | -      | 唯一标识符 |

#### 索引

- **sqlite_autoindex_tenants_1**: 🔒 唯一 (pk)

#### 表用途

**租户管理表** - 多租户系统的基础表

- 管理不同的租户（当前：`default_tenant`）
- 支持数据隔离和权限控制
- 为多用户系统提供基础架构

---

## 🎯 核心表关系总结

### 📊 数据流向图

```
文档上传 → 向量化 → 存储到ChromaDB
    ↓
┌─────────────────────────────────────────────────────────────┐
│                    ChromaDB 数据流                           │
├─────────────────────────────────────────────────────────────┤
│  1️⃣ tenants → databases → collections                      │
│     (租户)     (数据库)      (集合)                          │
│                                                             │
│  2️⃣ documents → embeddings_queue → embeddings              │
│     (文档)      (向量数据)         (向量索引)                │
│                                                             │
│  3️⃣ embedding_metadata ← segments                          │
│     (向量元数据)          (数据分段)                         │
└─────────────────────────────────────────────────────────────┘
```

### 🔑 关键表说明

#### 🏢 **管理层表**

- **`tenants`**: 租户管理（多租户隔离）
- **`databases`**: 逻辑数据库分组
- **`collections`**: 向量集合管理（核心配置）

#### 🧠 **向量存储层**

- **`embeddings_queue`**: ⭐ **最重要** - 存储实际向量数据和元数据
- **`embeddings`**: 向量索引表（ID 映射）
- **`embedding_metadata`**: 向量的键值对元数据

#### 🧩 **分段管理层**

- **`segments`**: 数据分段管理（VECTOR/METADATA 分段）
- **`segment_metadata`**: 分段配置信息
- **`max_seq_id`**: 分段序列号管理

#### 🔍 **搜索支持层**

- **`embedding_fulltext_search_*`**: 全文搜索功能表组
- **`collection_metadata`**: 集合配置（HNSW 参数）

#### ⚙️ **系统管理层**

- **`migrations`**: 数据库版本管理
- **`embeddings_queue_config`**: 向量队列配置
- **`maintenance_log`**: 维护日志

### 💡 重要发现

1. **向量数据存储**: 实际向量数据存储在 `embeddings_queue` 表中，每个向量 12288 字节（3072 维 ×4 字节）

2. **元数据管理**: 文档元数据以 JSON 格式存储，包含文件路径、文件名、文件类型等信息

3. **分段架构**: ChromaDB 使用分段存储，分为 VECTOR 分段和 METADATA 分段

4. **HNSW 配置**: 使用余弦相似度（cosine）进行向量搜索

5. **多租户支持**: 完整的租户 → 数据库 → 集合三层隔离架构

### 🚀 性能优化要点

- **向量搜索**: 基于 HNSW 算法的高效近似最近邻搜索
- **分段存储**: 支持大规模数据的分片存储和并行查询
- **索引优化**: 多个表都有针对性的索引设计
- **元数据过滤**: 支持基于元数据的高效过滤查询

---
